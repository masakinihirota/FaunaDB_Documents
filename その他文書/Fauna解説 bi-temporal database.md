

目次

第1章
Faunaとは？
第2章
簡単な例
第3章
FQLとは

第4章
SQLとFQLの違い
Temporal Databaseとは
第5章
BiTemporal Databaseとは
第6章
実例

第7章
時間
第8章
第9章
第10章





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●


# Faunaとは

Faunaの紹介
Faunaとはデータベースの名前です。
MySQLとかPostgres、SQLite等のように、
たくさんあるデータベースアプリケーションの一つです。
（少し前まではFaunaDBでした。）

Faunaは英語で
> 動物相（どうぶつそう、英:Fauna）
ある特定の地域と時間における動物を表す集合的な用語である。
これに対応する植物の集合の概念は植物相である。
さらに全生物を対象とする言葉に生物相がある。
ラテン語の仮名書きであるファウナの形でもよく使われる。

Faunaで検索するとFaunaデータベースの情報はまず出てこないので
**FaunaDB**でよく検索します。

Faunaではデータを操作する言語にSQLではなく、FQLを採用しています。

リレーショナルデータベース上でデータを操作するのにSQLを使用するのと同じように、
FQLではFaunaデータベース上のデータを操作するFauna専用のデータベース操作言語です。

**ここでFauna最大の疑問**、なぜデータベースなのにSQLを使わないのでしょうか？

普通、SQLは長年の実績があるしノウハウも豊富にあって技術も枯れていますから、
データベースを使うならSQL一択で他の選択肢はないと思います。

でも、それなのになぜFQLという謎のデータベース操作言語を使うのでしょうか？

それは、SQLは日時を文字列と認識しています、
FQLでは日時を日時として認識するからです。

意味がわかるでしょうか？

SQLでの日時は日頃よく使っているデータタイプだと、
触ったことがある人ならそう思うはずです。

でも本当にそうでしょうか？
SQLで日時を扱っているのでしょうか？

実を言うとSQLでは日時を扱っていません。
SQLでは数値と文字列の組み合わせたタイプの型なのです。

例えば、SQLでデータを上書きしたら過去のデータは消えてしまい再現できません
プログラム等で履歴等をサポートする必要があります。

Faunaは従来のデータベースに時系列をシステムとして組み込んだ
次世代型のデータベースなのです。

この時系列を組み込んだデータベースを
総じてTemporal Databaseといいます。

>英語でTemporalとは
現世の、世間的な、(空間に対して)時間的な、
一時の、(聖職者・教会に対して)聖職でない、
時を表わす、時制の、こめかみの、側頭の

Temporal Databaseはいくつか種類があって
Faunaはその数あるTemporal Databaseの種類の一つです。

Temporal Databaseとは
時間軸をデータベースの設計思想に組み込んだデータベースです。

時間を設計思想に組み込む？どういう言う意味でしょうか？

ちょっと整理しますとデータベースには次元の壁のようなものがあります。

- １次元、データ軸だけで表現するのがSQL
MySQLやPostgres、SQLiteなどのリレーショナルデータベースがこれに当たります。
※最新のデータベースではオプションで時系列をサポートしているデータベースもあります。
その場合は拡張SQLを使用しているそうです。（未確認）

- ２次元、データ軸、時間軸で表すタイプのデータベース
Fauna、FQL言語がこれに当たります。
FaunaはTemporal Databaseの一種であるBiTemporal Databaseです。

>BiTemporalとは
2つのTemporalという意味です。
時間を2つの要素に分解してシステムに組み込んでいるという意味です。
なにが2つかは後ほど説明します。

- ３次元、データ軸、時間軸、空間軸で表すタイプのデータベースもあります。
Spatio-temporal Database
時空間データベース
時間や空間的な情報とを関連付けて表示されるデータ群を
より直接的により効率的に扱うためのデータベースです。
これは全く知らないので詳しくはかけません。

#時間軸を組み込んだデータベース

Faunaは時間軸を組み込んだデータベースであり、
従来のリレーショナルデータベースの操作言語であるSQLは使えないので
FQLというFauna専用のデータベース操作言語を使用すると書きました。

では時間軸と組み込むとは何でしょうか？
リレーショナルデータベースとは何が違うのでしょうか？

# 簡単な例

あるデータベースに、
データを入力して新規作成して、
データを更新して、
データを削除します。

この場合、
リレーショナルデータベースでは
データの履歴を追うことは出来ません。

リレーショナルデータベースでは、
そのような履歴を追うには
自分でプログラムを書く必要があります。

Faunaは時間軸を取り入れたデータベースなので出来ます。
いつ入力し、いつ更新し、いつ削除したのかを
データベース側が記録してくれています。

ここで問題なのは使用する側が時間の概念を習得しておかないと
どのように動いているのか理解できない事です。

データベース上の時間を考えたことあるでしょうか？

時間は連続しているはずなのに
リレーショナルデータベース内の時間は離散的です。

> 離散的とは
連続的ではないさま。数学で、値や数量がとびとびになっているさま。
粒子や物体などの個数、実数のなかの整数、量子力学における物理量などが離散的な値をとる。

離散的とはここではその時点での時間です。

リレーショナルデータベースでは
あるデータを入力した時点、もしくは想定した時間を数値として入力します。
これではスナップショット的にデータを保存しているだけです。

> スナップショットとは
ある時点でのソースコードや、ファイル、ディレクトリ、
データベースファイルなどの状態を抜き出したもの

FaunaはTemporal Databaseと説明しましたが
扱うデータモデルは時系列を考慮した

BiTemporal Data Modelを使用しています。

このBiTemporal Data Modelとは何でしょうか？

それは、まず時系列のデータには2種類あると考えます。

valid time
transaction time
です。

valid timeは
ある要素が正しい場合にtrueとするパターン
データベース上にあるかどうかは関係がありません。

例
あなたが現実世界で2000年4月1日に入社したなら
2000年4月1日以降はtrueと判定されます。

transaction timeは
データベース上にデータがある時間です。

例
2000年4月1日に入社して
2020年3月31日に退社したなら
transaction timeは
2000年4月1日～2020年3月31日です。

上記の2種類を組み合わせると
4つのパターンができあがります。

１	どちらも使用しない
Snapshot Model
これがリレーショナルデータベースのよくある使い方です。

２	valid timeだけ使う
Valid Time Data Model
Historical DB
※詳しく知りませんごめんなさい

３
transactional timeだけ使う
Transactional Data Model
Rollback DB
※詳しく知りませんごめんなさい

４
valid time と transactional timeの両方を使う
BiTemporal Data Model
Fauna DB

ようやくFaunaの本体が見えてきました。

Faunaとはvalid time と transactional timeの両方のデータモデルを使用した
時系列を考慮したデータベースです。


時系列の概念を考慮した4つのパターンに分けました。

１の
Snapshot Model
このタイプは時刻情報を保持していません。
履歴の追跡は困難です。
追跡が不要なデータの場合はこのタイプのデータベースで十分です。
リレーショナルデータベース、

２の
Valid Time Data Model
リレーショナルデータベース、

３の
Transactional Data Model
リレーショナルデータベース、

４の
BiTemporal Data Model

valid time
transaction time
この2つを勉強していけばFaunaをより高度に使えるようになります。
これ以上はFaunaを紹介するという目的からずれてきますので
この記事はここまでにしておきます。

興味が湧いた方は下記URLが参考になります。

参考
BiTemporal Data Modelに入門中 - だいたいよくわからないブログ
https://matsu-chara.hatenablog.com/entry/2017/04/01/110000

時制データベース
https://ja.wikinew.wiki/wiki/Temporal_database#Implementations_in_notable_products


#その他
Faunaをリレーショナルデータベースとして使いたい場合は
GraphQLを使用すればいいと思います。
時系列の概念を特に意識すること無く使えます。

Faunaの特徴は
BiTempral databaseに加えて
サーバーレスデータベースだという特徴があります。
Vercelで簡単にそして安全に自作アプリに追加できます。












●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

有効時間は、
事実が現実に真実であった時間に関係する。
ある事象の有効時間とは、
その事象が現実世界で発生した壁時計の時刻であり、
その事象がデータベースに記録されているかどうかとは無関係である。
ある事実が将来の特定の時間に真となることがわかっている場合、
有効時間は将来にもなり得る。

トランザクション時間は、
事実が保存データとしてデータベースに存在していた時間に関するものである。
あるイベントのトランザクション時間（間隔）は、
そのイベントに関する情報をデータベースに挿入したトランザクションと、
その情報をデータベースから削除したトランザクションを特定するものである。



この2つの次元は直交しています。

どちらもサポートしていないデータモデルはスナップショットと呼ばれ、

有効時間のみをサポートする日付モデルはヒストリカルと呼ばれ、

トランザクション時間のみをサポートするものはロールバックと呼ばれ、


有効時間とトランスアクション時間の
両方をサポートするものはビテンポラルと呼ばれます
（テンポラルは、何らかの時間サポートを意味する一般的な用語です）
。







●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

決済システムの残高管理周りの DB 設計と戦略 - カンムテックブログ
https://tech.kanmu.co.jp/entry/2021/06/29/131649

Temporal Databaseを使えば－？



●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●


Temporal Structured Query Language
（TSQL）
と呼ばれています

SQLの拡張



●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

私達は過去の情報を維持しておきたい

データベースの中で実際に起こった時間を考慮します。

既存の行を更新したり、行を削除したりすることはありません。

行を削除することもありません。

そうすることで、過去に持っていた情報を

過去に持っていた情報を保持する

●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

従来のデータベースは

基本的には、現在の形のデータを

形態

どういうことかというと......例えば

社員の記録があるとします。

記録

現在の給料は......例えば

例えば......1万ドル

ドル

5年前の私の給料は...

5千ドルでした。

もしそうだとしたら

そのデータベースに1つのレコードがあって

そのデータベースに1つのレコードがあって、
それがsalaryフィールドを持っていたら、それはたぶん

おそらく

1万ドルとして保存されていますが、もし

しかし、あなたが知りたいのは

しかし、もしあなたが、監査などで

5年前、6年前のブライアンの給料は

5年前や6年前の

まだ現在の金額しか表示されません。

現在の金額を表示します。

それが私の言いたいことです。

データベースの90%以上を占めると思われる

テーブル

現在のデータベーステーブルの90％以上は

知っているのは

このスナップショットは、世界の

現在のバージョンでは

彼らは前のバージョンについてはあまり知らない。




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

もし、あなたが小売業者であれば

もしあなたが小売業者で

ある商品に特定のクーポンを提供したいが

ある商品に特定のクーポンを提供したいが、それを

しかし、それを提供したいのは一度に一つの商品に限られます。

そして、これらの

クーポンを使ったことのある人なら誰でも知っていると思います。

クーポン

私は嫌いですが......私の周りの多くの人は

私の周りの多くの人はそれを愛している

気が狂いそうになります......それはあなたが知っている

そこには

日付指定があったり

あらゆる種類の要求があります。

他の製品と一緒に使うことはできない

他の製品と一緒に使えないとか、そういうことです。

あなたがこの結論に達するために

クーポンを提供できるかどうかの結論を出すために

クーポン

この商品にクーポンを提供し、それを唯一のクーポンとすることができます。

クーポンの提供

他のクーポンだけでなく、他のクーポンも知っていなければなりません。

知る必要があります。

何時から何時まで存在するのかを知る必要があります。

いつ始まるのか、いつ終わるのかを知ることで

と言えるようにします。

今、この商品には別のクーポンがありますが

この商品には別のクーポンがありますが、来週の木曜日には

来週の木曜日にはもうありません。

クーポンを作成することができます。

クーポンを作成することができます。





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

最近では、この問題に対処するために、私たちは

履歴テーブルを作成します。

ある意味ではこの問題の一部を解決します。

問題

しかし、すべてを解決するわけではありません。

通常、履歴テーブルを作成するのは

履歴テーブルを作成するのは、例えば、従業員の

給与

えーと、特定の属性のためだけかもしれません。




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●


スナップショット

最終的には

登録したのか、退会したのか、だけど

それ以前のことはわからない

もし、その履歴表があれば

ほとんどの学校では

ほとんどの学校がそうだと思いますが......そうすれば、私たちは

知ることができます。


●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

歴史的に見ても

読んだかなどの歴史的な情報が必要になります。

監査は非常に重要で、特別な規定を設けない限り

特別な規定を設けない限り、これが

ここで重要なのは

効果的に行うことができないのです。

何年も何年も前から人々は

人々は

何年も何年も人々は、
この問題に普遍的に取り組むための様々な方法を検討してきました。

普遍的にアプローチする方法を模索してきました。

データベースを考えることはできないだろうか

データベースを考える方法はないだろうか？

時間的な懸念のすべての側面が処理されるような

そう

SQL標準に組み込むことはできますか？

規格に組み込むことはできますか？

それをサポートするデータタイプを作れるか

これらの疑問が

多くの研究を推進してきました。

80年代までさかのぼることができます。

それ以前にも読んだことがありますが

80年代、90年代から現在に至るまでの論文を

現在に至るまで、いくつかの論文を読みましたが

控えめに言っても、これは難しい問題です。

控えめに言っても難しい問題で、これから

いくつかの異なる側面に触れることになるでしょう。

しかし、これは非常に難しい問題です。

解決する




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

これを要約すると、従来のデータベースは

データベースは、企業のスナップショットです。

企業のスナップショットです。

過去の情報は状態の変更とみなされません

状態への変更とみなされるので、もし

私の給料を変更した場合、あなたは

し、その履歴テーブルを持っていない場合は

私の昔の給料は失われてしまいます。





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

履歴テーブルの

テンポラル・データベースのために、あるいは少なくとも

テンポラル・データベースのコンセプト

は、その履歴情報を維持してくれます。

情報を維持してくれます。

うまくいけばいいのですが......つまり、それを実現するためには

それを実現するためのピースを用意しなければならないかもしれませんが




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

ここでのアイデアは

私たちが変更を加えなければならないということです。

を提供しなければなりません。

方法を提供しなければなりませんし、それを効率的に行う必要があります。

効率的に行う必要があるということです。

この分野での懸念の1つは

この分野での懸念の一つは

特に大規模なデータでは

大規模データ

時間の要素を加えると

成分を加えると、データの変化の頻度に応じて

データの変化

千行のテーブルが

1,000行のテーブルが突然数百万行になるかもしれません。

数百万行になるかもしれませんね。

なぜなら

データの変化の頻度によっては

問題になる可能性があります。

この問題に対処する方法の1つは

対応策としては

履歴テーブルを作成し、それらを

別のテーブルに

別のテーブルに移すことで、現在の情報の

現在の情報のスナップショットテーブルを

少ない行数の現在の情報のスナップショットテーブルができ、それが

最も多くアクセスされるテーブル

より早くアクセスされることになります。





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

SQL

保存するためのデータ型が必要です。

例えば、テキストとして「私たちの車」を保存したり

数字を表すinを保存するようなものです。

のように、保存するデータタイプが必要です。

同じことが

時間的なデータタイプも同じです。




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

どのようなデータ型を使うのが適切なのかを

どのデータ型を使うのが適切かを考えるためには、まず

時間の種類は何かを分解する必要があります。

時間の種類は何か、そしてその中で私たちが

私はそのうちの3つを説明します。





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

すぐにわかると思いますが、最後の2つは

はちょっとしたグレーゾーンです。



●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

しかし、最初に考えたのは

データタイプ

瞬間のことです。

一瞬のうちに起こったこと

非常に特定の瞬間に起こったもの

例えば

私の口から出た言葉は

5秒前に私の口から出た言葉のように

私はxと言ったのだから、それは瞬間的なものだ。

それは簡単に表現できることであり

苦労するようなことではありません。

苦労することはありません。





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

アプリケーション・プログラミング・タイプの場合は

私たちは、日付や

日付、タイムスタンプ、時間などがあります。

これらはすべてsql規格の一部であり

規格の一部であり、
リレーショナル・データベース・マネジメ ントによって広く実装されています。

リレーショナル・データベース管理システムで

システムで広く実装されています。




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

1万ドルの給料をもらっていた。

万ドルの給料をもらっていました。

5年前から現在に至るまで

今日まで

これには明確な開始と終了が必要です。

開始と終了を明確にしなければなりません。




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

瞬間的に起こるインスタントとは違い、方向性があります。

瞬間的に起こるものとは違います。

瞬間的に起こるものとは違い、私たちができる限り

できる限り

アナログの世界のサンプルを

のアナログの世界から

時間の......期間には方向性がある

私は時間を進めているのか、あるいは戻しているのか。

時間を進めたり戻したりしますが、それは2点間で

方向性があります。

私たちは、この問題に対処する有効なタイプを持っていません。


SQLにはこれを扱う有効な型がないんだ。つまり、今のところまだ
SQLにはこれを扱う有効な型がないんだ。つまり、今のところまだ


●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

結果として得られるのはアンカーポイントですが

点ですが、間隔自体は

は、間隔自体は単なる

時間の説明に過ぎない




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

どうやって始まったのかわからないけど、もしあなたが

厳しくしたいのであれば

厳密に言うと、ピリオドと呼んだ方がいいと思います。

ピリオドと呼んだほうがいいと思います。

間隔には別の意味合いがあります。

時間の意味合いがあります。

時間という意味合いがありますが、多くの作家は

インターバルという言葉を、実際には

表現しています。

の2つの離散的な固定された時点での期間を表すのにも使います。

の時間ポイント

に加えて、その間の時間で

間隔は時間の量でもありますよね。

時間の量であるインターバルもあります。





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

データベースがレコードを変更したときの

実際の時間とは何の関係もありません。




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

時間性とは、2つの異なる軸で時間を定義することです。

時間を2つの異なる軸で定義することです。

を見てみましょう。

まず、取引時間があります。

トランザクション・タイムとは、単に

事実が取引された時ということです。

イベントログがあれば、それはそのイベントが

イベントログがあれば、そのイベントがログ上で処理された時だと

ログに

これは良いニュースだし、これは監査ログのようなものだ。

監査ログのようなもので、すべてのイベントを

イベントを永遠に保存することができます。

監査されているという安心感があります。

監査されているという安心感があります。




もうひとつの特徴は

一貫性のあるクエリが得られます。

取引された時ではなく、事実が真実であると言われた時です。

これは事実が取引された時ではなく、
事実が真実であると言われた時ですので、先ほどの取引の例に戻ると




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

Postgresはこれを擬似的に行います。

データを削除ではなく

元データは非表示にして、
新しいデータを新規作成して書き込むのです。

これならば事例欠順に記録していきますが
ちょっと考えれば
処理が複雑化していくのが目に見えます。

それで処理範囲を限定して
直近の5年以内のデータなどぐらいまでなどとしておいて
アクセスできる記録するデータの範囲を限定しておきます。
処理を軽くします。

サイトで過去の取引履歴直近の3ヶ月とか1年以内とか
見たことがあると思います。

実務では十分ですが、
実際の会社の記録としては不十分です。


完全な時間軸別データベースソリューションを目指す必要はありません。





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

時間が重要な役割を果たす

現在、時間データベースには2つの異なる時間の側面

時間データベースにおける時間の2つの異なる側面

1つ目は有効時間で、これは

ある事実が現実世界に対して真である期間

現実の世界に関して

2つ目は、トランザクション時間です。

時間である。

システムによって生成される時間です。

特定の事実がデータベースに格納されたときに

データベース

時間的データベースは時間的




●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●



用語
用語
用語

リレーショナルデータベース 
行と列によって構成された「表形式のテーブル」と呼ばれるデータの集合を、互いに関連付けて関係モデルを使ったデータベースのこと。 「RDB」と略されることもある。 最も普及しているデータベースシステムの1つ。 
データベースアプリケーション（MySQL、Postgres、SQLite等）

SQL リレーショナルデータベースで使われているデータベース操作言語
「Structured Query Language」の略で、直訳すると「構造化問い合わせ言語」。 コンピュータ言語のひとつですが、プログラミング言語ではありません。 リレーショナルデータベース(RDB)のデータを操作するための言語です。

Fauna クラウド型のデータベースアプリケーション NoSQL
FQL Fauna専用のデータベース操作言語
CRUD	Create（生成）、Read（読み取り）、Update（更新）、Delete（削除）の頭文字をとっている。
それぞれの命令ごとにプログラムを書くので長くなりがち。

REST REST(REpresentational State Transfer)はWebサービスの設計モデルです。
RESTなWebサービスは、そのサービスのURIにHTTPメソッドでアクセスすることでデータの送受信を行います。
パラメータを指定して特定のURLにHTTPでアクセスすると、XMLやJSONなどで記述されたメッセージが送られてくるようなシステム、

GraphQL CRUDの処理を一つのエンドポイントで行うのでデータ操作が楽。
エンドポイント	データベースの出入り口、ここ以外からはデータベースへアクセスは出来ない。
Temporal 時間的な、時を表わす、時制の
クロノン 最小時間単位

JSON データベースーアプリケーション間でデータをやり取りするためのフォーマット。

履歴

ロールバック





●●●●●●●●●●●●●●●●●●●●●●●
●●●●●●●●●●●●●●●●●●●●●●●

参照

動物相 - Wikipedia
https://ja.wikipedia.org/wiki/%E5%8B%95%E7%89%A9%E7%9B%B8

temporal とは 意味・読み方・表現 | Weblio英和辞書
https://ejje.weblio.jp/content/temporal

BiTemporal Data Modelに入門中 - だいたいよくわからないブログ
https://matsu-chara.hatenablog.com/entry/2017/04/01/110000









